---
import { getCollection } from "astro:content";
import Layout from "../../../layout/default.astro";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const uniqueTags = [
    ...new Set(allPosts.map((post) => post.data.tags).flat()),
  ];

  return uniqueTags
    .filter((tag) => !!tag) // filter out undefined
    .map((tag) => {
      const filteredPosts: any = allPosts.filter((post) => {
        return post.data.tags && post.data.tags.includes(tag);
      });
      return {
        params: { tag },
        props: { posts: filteredPosts },
      };
    });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<Layout pageTitle={`Posts tagged with #${tag}`}>
  <div class="mb-10">
    <h2 class="text-3xl font-semibold dark:text-white">
      Posts tagged with #{tag}
    </h2>
  </div>
  <ol class="ml-4 relative border-l border-gray-200 dark:border-gray-700">
    {
      posts
        .sort(
          (a: any, b: any) =>
            new Date(b.data.created).getTime() -
            new Date(a.data.created).getTime()
        )
        .map((blogPostEntry: any) => (
          <li class="mb-10 ml-4">
            <div class="absolute w-3 h-3 bg-gray-200 rounded-full mt-1.5 -left-1.5 border border-white dark:border-gray-900 dark:bg-gray-700" />
            <time class="mb-1 text-sm font-normal leading-none text-gray-400 dark:text-gray-500">
              {new Date(blogPostEntry.data.created).toDateString()}
            </time>
            <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">
              <a href={`/blog/${blogPostEntry.slug}`}>
                {blogPostEntry.data.title}
              </a>
            </h3>
            {blogPostEntry.data.tags && (
              <p class="mb-4 text-base font-normal text-gray-500 dark:text-gray-400">
                {blogPostEntry.data.tags.map((t: string) => (
                  <a class="mr-4 inline-block mb-2 hover:underline" href={`/blog/tags/${t}`}>
                    #{t}
                  </a>
                ))}
              </p>
            )}
          </li>
        ))
    }
  </ol>
</Layout>
