---
import { MatchStats } from "astro:db";
import Layout from "../../../layout/default.astro";
import { db, Player, Match, eq, or } from "astro:db";

const rows = await db
  .select()
  .from(Match)
  .innerJoin(MatchStats, eq(Match.id, MatchStats.matchId))
  .innerJoin(Player, eq(MatchStats.playerId, Player.id));

const result = rows.reduce((acc: any, { Match, MatchStats, Player }) => {
  if (!acc[Match.id]) {
    acc[Match.id] = {
      ...Match,
      players: [],
    };
  }
  acc[Match.id].players.push({ ...Player, frames: MatchStats.framesWon });

  return acc;
}, {});
---

<Layout pageTitle="DPK Matches">
  <h1 class="text-xl my-6 text-center font-light dark:text-gray-300">
    DPK Matches
  </h1>

  <div class="relative overflow-x-auto shadow-sm rounded-lg">
    <table
      class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400"
    >
      <tbody>
        {
          Object.values(result).map((match: any) => {
            return (
              <tr class="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700 border-gray-200">
                <td class="py-4 font-medium  text-right text-gray-900 whitespace-nowrap dark:text-white">
                  {match.players[0].name}
                </td>
                <td class="py-4 w-16 text-right">{match.players[0].frames}</td>
                <td class="py-4 text-center">-</td>
                <td class="py-4 w-16">{match.players[1].frames}</td>
                <td class="py-4  font-medium text-gray-900 whitespace-nowrap dark:text-white">
                  {match.players[1].name}
                </td>
                <td class="py-4">{match.status}</td>
                <td class="py-4">
                  {match.status !== "finished" && (
                    <a
                      href={`/admin/match/${match.id}`}
                      class="font-medium text-blue-600 dark:text-blue-500 hover:underline"
                    >
                      Edit
                    </a>
                  )}
                </td>
              </tr>
            );
          })
        }
        <tr>
          <th scope="col" class="py-4"></th>
          <th scope="col" class="py-4"></th>
          <th scope="col" class="py-4"></th>
          <th scope="col" class="py-4"></th>
          <th scope="col" class="p-4 text-right" colspan="3"
            ><a
              href="/admin/match/new"
              class="font-medium text-blue-600 dark:text-blue-500 hover:underline"
              >New match</a
            ></th
          >
        </tr>
      </tbody>
    </table>
  </div>
</Layout>
