---
import Layout from "../../layout/default.astro";
import { SignedIn, SignOutButton } from "@clerk/astro/components";
import PlayerCard from "../../components/PlayerCard.astro";
import { db, eq, Player, Match, MatchStats } from "astro:db";
const user = await Astro.locals.currentUser();
const currentPlayer = Astro.locals.player;

const formMatchStats = await db
  .select()
  .from(MatchStats)
  .innerJoin(Match, eq(MatchStats.matchId, Match.id))
  .where(eq(MatchStats.playerId, Astro.locals.player.id))
  .limit(5);
const form = formMatchStats.reduce((acc, { Match, MatchStats }) => {
  const gameForm = Match.raceTo === MatchStats.framesWon ? 1 : -1;
  acc += gameForm;
  return acc;
}, 0);

const rows = await db
  .select()
  .from(Match)
  .innerJoin(MatchStats, eq(Match.id, MatchStats.matchId))
  .innerJoin(Player, eq(MatchStats.playerId, Player.id));
const results = rows.reduce((acc: any, { Match, MatchStats, Player }) => {
  if (!acc[Match.id]) {
    acc[Match.id] = {
      ...Match,
      players: [],
    };
  }
  acc[Match.id].players.push({ ...Player, frames: MatchStats.framesWon });

  return acc;
}, {});

const recentMatches = Object.values(results).filter(
  (m) =>
    m.players[0].id === Astro.locals.player.id ||
    m.players[1].id === Astro.locals.player.id
);
---

<Layout pageTitle="DPK Profile">
  <PlayerCard
    name={currentPlayer.name}
    picture={user?.imageUrl}
    form={form}
    handicap={currentPlayer.handicap}
  >
    <SignedIn>
      <SignOutButton
        class:list={"mx-auto text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-300 font-medium rounded-full text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"}
      />
    </SignedIn>
  </PlayerCard>
  <h2 class="text-l my-4 text-center font-light dark:text-gray-300">
    Recent matches
  </h2>
  <div class="relative overflow-x-auto shadow-sm rounded-lg">
    <table
      class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400"
    >
      <tbody>
        {
          recentMatches.length ? (
            recentMatches.map((match: any) => {
              return (
                <tr class="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700 border-gray-200">
                  <td class="py-4 font-medium  text-right text-gray-900 whitespace-nowrap dark:text-white">
                    {match.players[0].name}
                  </td>
                  <td class="py-4 w-16 text-right">
                    {match.players[0].frames}
                  </td>
                  <td class="py-4 text-center">-</td>
                  <td class="py-4 w-16">{match.players[1].frames}</td>
                  <td class="py-4  font-medium text-gray-900 whitespace-nowrap dark:text-white">
                    {match.players[1].name}
                  </td>
                </tr>
              );
            })
          ) : (
            <tr class="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700 border-gray-200">
              <td class="py-4 font-medium text-center text-gray-900 whitespace-nowrap dark:text-white">
                No matches played yet.
              </td>
            </tr>
          )
        }
      </tbody>
    </table>
  </div>
</Layout>
